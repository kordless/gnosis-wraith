<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gnosis Wraith | Forge</title>
    
    <!-- React and ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.2/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              'terminal-green': '#4ade80',
            }
          }
        }
      }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Prism.js for code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-powershell.min.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/gnosis.css">
    
    <!-- Utility functions - Load BEFORE components -->
    <script src="/static/js/gnosis-utils.js"></script>
    <script src="/static/js/global-utils.js"></script>
    
    <style>
        /* Custom CSS for forge */
        .break-words {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        html, body {
            min-height: 100vh;
            background-color: #111827;
            margin: 0;
            padding: 0;
        }
        
        body {
            overflow-y: auto; 
            min-height: 100vh;
            max-height: 100vh;
        }
        
        .code-container {
            overflow-y: auto !important;
        }
        
        pre.code-block {
            background-color: #1e1e1e !important;
            color: #d4d4d4;
            padding: 20px;
            margin: 0;
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
    </style>
</head>
<body class="bg-gray-900 p-0 m-0">
    <div id="root"></div>
    
    <!-- Template variables for JavaScript -->
    <script>
        // Pass template variables to JavaScript
        window.GNOSIS_CONFIG = {
            active_page: "forge"
        };
    </script>
    
    <!-- Component modules - Load AFTER utilities -->
    <script src="/static/js/components/auth-component.js" type="text/babel"></script>
    
    <!-- Forge-specific components -->
    <script type="text/babel">
        {% raw %}
        // Forge Language Selector Component
        const ForgeLanguageSelector = ({ 
            selectedLanguage, 
            setSelectedLanguage, 
            customLanguage, 
            setCustomLanguage,
            commentsLevel,
            setCommentsLevel,
            includeErrorHandling,
            setIncludeErrorHandling,
            disabled = false,
            authStatus = 'unauthorized'
        }) => {
            const languages = {
                python: { name: 'Python', icon: 'fab fa-python', color: 'text-blue-400' },
                javascript: { name: 'JavaScript', icon: 'fab fa-js-square', color: 'text-yellow-400' },
                bash: { name: 'Bash', icon: 'fas fa-dollar-sign', color: 'text-green-400' },
                powershell: { name: 'PowerShell', icon: 'fas fa-terminal', color: 'text-blue-300' }
            };


            return (
                <div className="flex justify-between items-center mb-2">
                    <div className="flex items-center space-x-6 text-xs text-gray-400">
                        <div className="flex items-center space-x-2">
                            <div className="flex items-center space-x-2 bg-gray-900 p-1 rounded">
                                {Object.entries(languages).map(([key, lang]) => (
                                    <label key={key} className={`cursor-pointer px-2 py-1 rounded hover:bg-gray-700 ${selectedLanguage === key ? 'bg-purple-800 text-white' : ''} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`} title={lang.name}>
                                        <input
                                            type="radio"
                                            name="language"
                                            value={key}
                                            checked={selectedLanguage === key}
                                            onChange={() => !disabled && setSelectedLanguage(key)}
                                            className="sr-only"
                                            disabled={disabled}
                                        />
                                        <i className={`${lang.icon}`}></i>
                                    </label>
                                ))}
                            </div>
                            
                            {/* Custom Language Input */}
                            <div className="flex space-x-1">
                                <input 
                                    type="text"
                                    className={`w-20 px-2 py-1 bg-gray-900 border border-gray-700 rounded text-xs ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    placeholder="Custom..."
                                    value={selectedLanguage === 'custom' ? customLanguage : ''}
                                    onChange={(e) => {
                                        if (!disabled) {
                                            setCustomLanguage(e.target.value);
                                            if (e.target.value) {
                                                setSelectedLanguage('custom');
                                            }
                                        }
                                    }}
                                    disabled={disabled}
                                />
                                <button
                                    className={`px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    onClick={() => {
                                        if (!disabled && customLanguage && customLanguage.trim()) {
                                            const savedLanguages = JSON.parse(localStorage.getItem('forge_custom_languages') || '[]');
                                            if (!savedLanguages.includes(customLanguage.trim())) {
                                                savedLanguages.push(customLanguage.trim());
                                                localStorage.setItem('forge_custom_languages', JSON.stringify(savedLanguages));
                                            }
                                            setSelectedLanguage('custom');
                                        }
                                    }}
                                    disabled={disabled}
                                >
                                    Add
                                </button>
                            </div>
                            
                        </div>
                        
                        <div className="flex items-center space-x-2">
                            <div className="flex items-center space-x-2 bg-gray-900 p-1 rounded">
                                {[1, 2, 3].map(level => (
                                    <label key={level} className={`cursor-pointer px-2 py-1 rounded hover:bg-gray-700 ${commentsLevel === level ? 'bg-yellow-800 text-white' : ''} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`} title={`Comments: ${level === 1 ? 'Minimal' : level === 2 ? 'Standard' : 'Maximum'}`}>
                                        <input
                                            type="radio"
                                            name="comments"
                                            value={level}
                                            checked={commentsLevel === level}
                                            onChange={() => !disabled && setCommentsLevel(level)}
                                            className="sr-only"
                                            disabled={disabled}
                                        />
                                        {level === 1 ? 'MIN' : level === 2 ? 'STD' : 'MAX'}
                                        {commentsLevel === level && authStatus === 'authorized' && <span className="ml-1">ðŸ’¬</span>}
                                    </label>
                                ))}
                            </div>
                        </div>
                        
                        <div className="flex items-center space-x-2">
                            <div className="flex items-center space-x-2 bg-gray-900 p-1 rounded">
                                <label className={`cursor-pointer px-2 py-1 rounded transition-colors hover:bg-gray-700 ${includeErrorHandling ? 'bg-purple-800 text-white' : ''} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`} title={`Error Handling: ${includeErrorHandling ? 'Enabled' : 'Disabled'}`}>
                                    <input
                                        type="checkbox"
                                        checked={includeErrorHandling}
                                        onChange={(e) => !disabled && setIncludeErrorHandling(e.target.checked)}
                                        className="sr-only"
                                        disabled={disabled}
                                    />
                                    <i className={`fas ${includeErrorHandling ? 'fa-shield-alt' : 'fa-exclamation-triangle'}`}></i>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Forge Code Input Component
        const ForgeCodeInput = ({ 
            authStatus,
            inputValue, 
            setInputValue, 
            handleAuthenticate,
            handleGenerateCode,
            isGenerating,
            disabled = false
        }) => {
            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    if (authStatus === 'authorized') {
                        handleGenerateCode();
                    } else {
                        handleAuthenticate();
                    }
                }
            };

            const getPlaceholder = () => {
                if (authStatus === 'authorized') {
                    return "Describe the code you want to generate...";
                } else {
                    return "Enter authentication key...";
                }
            };

            const getButtonText = () => {
                if (authStatus === 'authorized') {
                    return isGenerating ? (
                        <>
                            <i className="fas fa-spinner fa-spin mr-2"></i>
                            Forging...
                        </>
                    ) : (
                        'Generate'
                    );
                } else {
                    return 'Authenticate';
                }
            };

            const isButtonDisabled = () => {
                if (authStatus === 'authorized') {
                    return isGenerating || !inputValue.trim() || disabled;
                } else {
                    return !inputValue.trim() || disabled;
                }
            };

            return (
                <div className="flex space-x-2">
                    <input
                        type={authStatus === 'authorized' ? 'text' : 'password'}
                        placeholder={getPlaceholder()}
                        className={`flex-grow px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:outline-none focus:border-purple-500 ${
                            disabled ? 'opacity-50 cursor-not-allowed' : ''
                        }`}
                        value={inputValue}
                        onChange={(e) => !disabled && setInputValue(e.target.value)}
                        onKeyPress={handleKeyPress}
                        disabled={disabled}
                    />
                    <button
                        className={`px-4 py-2 bg-purple-800 hover:bg-purple-700 text-white rounded disabled:opacity-50 ${
                            disabled ? 'cursor-not-allowed' : ''
                        }`}
                        onClick={authStatus === 'authorized' ? handleGenerateCode : handleAuthenticate}
                        disabled={isButtonDisabled()}
                    >
                        {getButtonText()}
                    </button>
                </div>
            );
        };

        // Forge Code Display Component
        const ForgeCodeDisplay = ({ 
            generatedCode, 
            selectedLanguage, 
            customLanguage,
            codeOutputRef,
            copyToClipboard,
            downloadCode
        }) => {
            const languages = {
                python: { name: 'Python', icon: 'fab fa-python', color: 'text-blue-400' },
                javascript: { name: 'JavaScript', icon: 'fab fa-js-square', color: 'text-yellow-400' },
                bash: { name: 'Bash', icon: 'fas fa-dollar-sign', color: 'text-green-400' },
                powershell: { name: 'PowerShell', icon: 'fas fa-terminal', color: 'text-blue-300' }
            };


            return (
                <div className="bg-gray-800 border border-gray-700 rounded-md overflow-auto code-container">
                    <div className="px-4 py-2 border-b border-gray-700 bg-gray-900 flex justify-between items-center">
                        <div className="flex items-center space-x-2">
                            <h2 className="text-lg font-semibold text-green-400">Generated Code</h2>
                            <div className="flex items-center space-x-1">
                                <i className={`${languages[selectedLanguage]?.icon || 'fas fa-code'} ${languages[selectedLanguage]?.color || 'text-gray-400'}`}></i>
                                <span className="text-sm text-gray-400">{languages[selectedLanguage]?.name || customLanguage || 'Custom'}</span>
                            </div>
                        </div>
                        <div className="flex space-x-2">
                            <button 
                                className="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded"
                                onClick={async () => {
                                    const success = await copyToClipboard(generatedCode);
                                    // Visual feedback could be added here
                                }}
                            >
                                <i className="fas fa-copy mr-1"></i>Copy
                            </button>
                            <button 
                                className="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded"
                                onClick={() => downloadCode(generatedCode, selectedLanguage)}
                            >
                                <i className="fas fa-download mr-1"></i>Download
                            </button>
                        </div>
                    </div>
                    <div className="p-4" ref={codeOutputRef}>
                        <pre className="code-block">
                            <code className={`language-${selectedLanguage}`}>
                                {generatedCode}
                            </code>
                        </pre>
                    </div>
                </div>
            );
        };

        // Main Forge Application
        const GnosisForgeInterface = () => {
            const { useState, useEffect, useRef } = React;
            
            // Authentication state
            const [authStatus, setAuthStatus] = useState('unauthorized');
            const [inputValue, setInputValue] = useState('');
            const [systemStatus, setSystemStatus] = useState('initializing');
            
            // Forge-specific state
            const [selectedLanguage, setSelectedLanguage] = useState('python');
            const [customLanguage, setCustomLanguage] = useState('');
            const [generatedCode, setGeneratedCode] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [commentsLevel, setCommentsLevel] = useState(2);
            const [includeErrorHandling, setIncludeErrorHandling] = useState(true);
            
            const codeOutputRef = useRef(null);
            
            // Language configurations - Using Jinja2 includes
            const languages = {
                python: { 
                    name: 'Python', 
                    icon: 'fab fa-python', 
                    color: 'text-blue-400',
                    defaultCode: `{{ include('includes/code_examples.py') | safe }}`
                },
                javascript: { 
                    name: 'JavaScript', 
                    icon: 'fab fa-js-square', 
                    color: 'text-yellow-400',
                    defaultCode: `{{ include('includes/code_examples.js') | safe }}`
                },
                bash: { 
                    name: 'Bash', 
                    icon: 'fas fa-dollar-sign', 
                    color: 'text-green-400',
                    defaultCode: `{{ include('includes/code_examples.sh') | safe }}`
                },
                powershell: { 
                    name: 'PowerShell', 
                    icon: 'fas fa-terminal', 
                    color: 'text-blue-300',
                    defaultCode: `{{ include('includes/code_examples.ps1') | safe }}`
                }
            };
            
            // Initialize authentication
            useEffect(() => {
                // Check for stored auth code - IMPORTANT: Only check, don't auto-authenticate
                const storedAuthCode = localStorage.getItem('gnosis_auth_code') || CookieUtils.getCookie('gnosis_auth_code');
                
                // Only set to authorized if we have a VALID code AND it matches the pattern
                if (storedAuthCode && /^c0d3z\d{4}$/i.test(storedAuthCode)) {
                    setAuthStatus('authorized');
                }
                
                // Set initial code from includes
                setGeneratedCode(languages[selectedLanguage].defaultCode);
                
                // Check server health
                checkServerHealth();
                
                setTimeout(() => setSystemStatus('online'), 1000);
            }, []);
            
            // Update code when language changes
            useEffect(() => {
                if (languages[selectedLanguage] && !generatedCode.includes('Generated code for:')) {
                    setGeneratedCode(languages[selectedLanguage].defaultCode);
                }
                
                // Re-highlight code
                setTimeout(() => {
                    if (window.Prism && codeOutputRef.current) {
                        Prism.highlightAllUnder(codeOutputRef.current);
                    }
                }, 100);
            }, [selectedLanguage]);
            
            // Re-highlight when code changes
            useEffect(() => {
                setTimeout(() => {
                    if (window.Prism && codeOutputRef.current) {
                        Prism.highlightAllUnder(codeOutputRef.current);
                    }
                }, 100);
            }, [generatedCode]);
            
            const checkServerHealth = async () => {
                try {
                    const response = await fetch('/health', { method: 'HEAD', cache: 'no-cache' });
                    setSystemStatus(response.ok ? 'online' : 'degraded');
                } catch (error) {
                    setSystemStatus('offline');
                }
            };
            
            // Stub logging function for forge (no logs display)
            const addLog = (message) => {
                console.log('Forge Log:', message);
            };

            // Use the unified authentication component
            const authComponent = AuthenticationComponent({
                authStatus,
                setAuthStatus,
                inputValue,
                setInputValue,
                addLog
            });

            const handleAuthenticate = () => {
                // Delegate to the unified auth component
                if (window.AuthenticationComponent) {
                    const component = window.AuthenticationComponent({
                        authStatus,
                        setAuthStatus,
                        inputValue,
                        setInputValue,
                        addLog
                    });
                    
                    // The component handles authentication internally
                    // We just need to trigger it manually since it's logic-only
                    if (inputValue.trim()) {
                        setAuthStatus('authenticating');
                        addLog(`Authentication attempt: ${inputValue.substring(0, 3)}${'*'.repeat(inputValue.length - 3)}`);
                        
                        // Check if input is a valid code
                        const codePattern = /^c0d3z\d{4}$/i;

                        if (codePattern.test(inputValue)) {
                            setTimeout(() => {
                                // Check if this is a different code than what's currently stored
                                const currentStoredCode = localStorage.getItem('gnosis_auth_code') || CookieUtils.getCookie('gnosis_auth_code');
                                
                                if (currentStoredCode && currentStoredCode !== inputValue) {
                                    // Different code - clear all existing data first
                                    addLog(`New authentication code detected`);
                                    addLog(`Clearing previous session data for security`);
                                    
                                    // Clear all localStorage except the new auth code we're about to set
                                    localStorage.clear();
                                    
                                    // Clear all cookies
                                    document.cookie.split(";").forEach(function(c) { 
                                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                                    });
                                    
                                    addLog(`Previous session data cleared`);
                                }
                                
                                setAuthStatus('authorized');
                                addLog('Authentication successful');
                                addLog(`Access code verified: ${inputValue}`);
                                addLog('Distributed crawler system online');
                                addLog('Memory banks accessible');
                                setInputValue('');
                                
                                // Store the new auth code in both localStorage and cookies
                                localStorage.setItem('gnosis_auth_code', inputValue);
                                
                                // Also store in cookie with 90 day expiration
                                CookieUtils.setCookie('gnosis_auth_code', inputValue, 90);
                            }, 1000);
                        } else if (inputValue.toLowerCase() === 'password') {
                            // Legacy password for testing
                            setTimeout(() => {
                                setAuthStatus('authorized');
                                addLog('Legacy authentication successful');
                                addLog('Distributed crawler system online');
                                addLog('Memory banks accessible');
                                addLog('WARNING: Using legacy credentials');
                                setInputValue('');
                            }, 1000);
                        } else {
                            // Failed authentication
                            setTimeout(() => {
                                setAuthStatus('unauthorized');
                                addLog('Authentication failed');
                                addLog('Access denied: Invalid code format');
                                addLog('Required format: c0d3zXXXX where XXXX is a 4-digit number');
                                setInputValue('');
                            }, 1000);
                        }
                    }
                }
            };
            
            const handleGenerateCode = async () => {
                if (!inputValue.trim() || authStatus !== 'authorized') return;
                
                setIsGenerating(true);
                
                try {
                    // Simulate code generation
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    const mockCode = generateMockCode(inputValue, selectedLanguage, commentsLevel, includeErrorHandling);
                    setGeneratedCode(mockCode);
                } catch (error) {
                    console.error('Code generation failed:', error);
                    setGeneratedCode('# Error generating code: ' + error.message);
                } finally {
                    setIsGenerating(false);
                    setInputValue('');
                }
            };
            
            const generateMockCode = (query, language, comments, errorHandling) => {
                // Use Jinja2 includes for generated templates
                const templates = {
                    python: `{{ include('includes/generated_templates.py') | safe }}`,
                    javascript: `{{ include('includes/generated_templates.js') | safe }}`,
                    bash: `{{ include('includes/generated_templates.sh') | safe }}`,
                    powershell: `{{ include('includes/generated_templates.ps1') | safe }}`
                };
                
                // For custom languages, create a generic template
                if (language === 'custom' && customLanguage) {
                    return '# Generated ' + customLanguage + ' code for: ' + query + '\n# Custom language: ' + customLanguage + '\n# Add your ' + customLanguage + ' implementation here\n\n# Example structure for Gnosis Wraith API integration:\n# 1. Set up HTTP client\n# 2. Create request payload with URL\n# 3. Send POST request to http://localhost:5678/api/crawl\n# 4. Handle response and extract data\n\n# Please adapt this template for ' + customLanguage + ' syntax and conventions';
                }
                
                return templates[language] || templates.python;
            };
            
            const copyToClipboard = async (text) => {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (err) {
                    return false;
                }
            };
            
            const downloadCode = (code, language) => {
                const extensions = {
                    python: '.py',
                    javascript: '.js',
                    bash: '.sh',
                    powershell: '.ps1'
                };
                
                let extension = extensions[language] || '.txt';
                let filename = 'gnosis_wraith_generated';
                
                if (language === 'custom' && customLanguage) {
                    filename = 'gnosis_wraith_' + customLanguage.toLowerCase();
                    const lang = customLanguage.toLowerCase();
                    if (lang.includes('java')) extension = '.java';
                    else if (lang.includes('php')) extension = '.php';
                    else if (lang.includes('ruby')) extension = '.rb';
                    else if (lang.includes('go')) extension = '.go';
                    else if (lang.includes('rust')) extension = '.rs';
                    else if (lang.includes('c++') || lang.includes('cpp')) extension = '.cpp';
                    else if (lang.includes('c#') || lang.includes('csharp')) extension = '.cs';
                    else extension = '.txt';
                }
                
                const blob = new Blob([code], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename + extension;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            
            const handleLogout = () => {
                if (confirm('Are you sure you want to log out?')) {
                    localStorage.removeItem('gnosis_auth_code');
                    CookieUtils.deleteCookie('gnosis_auth_code');
                    setAuthStatus('unauthorized');
                    setInputValue('');
                }
            };
            
            return (
                <div className="min-h-screen bg-gray-900 text-green-400 p-4 font-mono">
                    <div className="w-full mx-auto flex flex-col">
                        <header className="mb-4">
                            <div className="flex justify-between items-center">
                                <h1 className="text-2xl md:text-3xl font-bold">GNOSIS WRAITH</h1>
                                <div className="flex items-center space-x-2">
                                    <a href="https://github.com/kordless/gnosis-wraith" target="_blank" className="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-xs">
                                        VERSION 3.2.7
                                    </a>
                                </div>
                            </div>
                            <div className="flex items-center space-x-2 mt-2">
                                <div className={`h-3 w-3 rounded-full ${
                                    systemStatus === 'online' ? 'bg-green-500' : 
                                    systemStatus === 'degraded' ? 'bg-yellow-500' :
                                    systemStatus === 'offline' ? 'bg-red-500' : 
                                    'bg-gray-500'
                                }`}></div>
                                <span className="text-sm uppercase">System Status: {systemStatus}</span>
                                <div className="ml-auto text-xs text-gray-500">
                                    Press <kbd className="px-1 py-0.5 bg-gray-800 rounded border border-gray-600">Enter</kbd> to {authStatus === 'authorized' ? 'generate' : 'authenticate'}
                                </div>
                            </div>
                        </header>

                        {/* Navigation Tabs */}
                        <div className="bg-gray-800 border border-gray-700 rounded-md p-4 mb-4">
                            <div className="flex mb-2 border-b border-gray-700 justify-between items-center">
                                <div className="flex">
                                    <a 
                                        href="/wraith"
                                        className="px-4 py-2 text-gray-400 hover:text-green-400">
                                        <i className="fas fa-spider mr-2"></i>Crawler
                                    </a>
                                    <button 
                                        className="px-4 py-2 border-b-2 border-purple-500 text-purple-400">
                                        <i className="fas fa-hammer mr-2"></i>Forge
                                    </button>
                                    <a 
                                        href="/vault" 
                                        className="px-4 py-2 text-gray-400 hover:text-blue-400">
                                        <i className="fas fa-archive mr-2"></i>Vault
                                    </a>
                                    <a 
                                        href="/about"
                                        className="px-4 py-2 text-gray-400 hover:text-orange-400">
                                        <i className="fas fa-info-circle mr-2"></i>About
                                    </a>
                                </div>
                                
                                {/* LLM Controls and Logout - Same row as tabs, same styling as crawler */}
                                {authStatus === 'authorized' && (
                                    <div className="flex items-center space-x-4 text-xs text-gray-400">
                                        {/* LLM Provider Selector */}
                                        <div className="flex items-center space-x-1 bg-gray-900 p-1 rounded">
                                            <select 
                                                className="px-2 py-1 bg-gray-900 border border-gray-700 rounded text-xs"
                                                value={localStorage.getItem('gnosis_wraith_llm_provider') || 'anthropic'}
                                                onChange={(e) => {
                                                    localStorage.setItem('gnosis_wraith_llm_provider', e.target.value);
                                                }}
                                            >
                                                <option value="anthropic">Anthropic (Claude)</option>
                                                <option value="openai">OpenAI (GPT)</option>
                                                <option value="gemini">Google (Gemini)</option>
                                            </select>
                                        </div>
                                        
                                        {/* API Token Management */}
                                        {(() => {
                                            const provider = localStorage.getItem('gnosis_wraith_llm_provider') || 'anthropic';
                                            const cookieNames = {
                                                'anthropic': 'gnosis_wraith_llm_token_anthropic',
                                                'openai': 'gnosis_wraith_llm_token_openai',
                                                'gemini': 'gnosis_wraith_llm_token_gemini'
                                            };
                                            const cookieName = cookieNames[provider];
                                            const currentKey = CookieUtils.getCookie(cookieName);
                                            
                                            return (
                                                <div className="flex items-center space-x-1 bg-gray-900 p-1 rounded">
                                                    <input 
                                                        type="password"
                                                        className="flex-grow px-2 py-1 bg-gray-900 border border-gray-700 rounded text-xs cursor-pointer"
                                                        placeholder={currentKey ? "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" : "Click 'Set' to configure"}
                                                        value={currentKey ? "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" : ""}
                                                        readOnly={true}
                                                        title="Click 'Set' button to configure API token"
                                                        onClick={() => {
                                                            // Click the Set/Clear button when field is clicked
                                                            const button = document.querySelector(`button:contains("${currentKey ? 'Clear' : 'Set'}")`);
                                                            if (button) button.click();
                                                        }}
                                                    />
                                                    <button
                                                        className="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs"
                                                        onClick={() => {
                                                            if (currentKey) {
                                                                // Create confirmation modal for clearing
                                                                const confirmBox = document.createElement('div');
                                                                confirmBox.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
                                                                confirmBox.innerHTML = `
                                                                  <div class="bg-gray-800 border border-gray-700 rounded-md p-4 max-w-md w-full">
                                                                    <div class="text-green-400 font-semibold mb-2">Confirm</div>
                                                                    <div class="text-white mb-4">Are you sure you want to remove this API key?</div>
                                                                    <div class="flex justify-end space-x-2">
                                                                      <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm" id="cancel-btn">Cancel</button>
                                                                      <button class="px-3 py-1 bg-red-700 hover:bg-red-600 text-white rounded text-sm" id="confirm-btn">Remove</button>
                                                                    </div>
                                                                  </div>
                                                                `;
                                                                document.body.appendChild(confirmBox);
                                                                
                                                                // Add event handlers
                                                                document.getElementById('cancel-btn').addEventListener('click', () => {
                                                                  document.body.removeChild(confirmBox);
                                                                });
                                                                document.getElementById('confirm-btn').addEventListener('click', () => {
                                                                  CookieUtils.deleteCookie(cookieName);
                                                                  document.body.removeChild(confirmBox);
                                                                  // Force page refresh to update display
                                                                  window.location.reload();
                                                                });
                                                            } else {
                                                                // Create modal for entering new key
                                                                const provider = localStorage.getItem('gnosis_wraith_llm_provider') || 'anthropic';
                                                                let keyName, placeholder;
                                                                switch(provider) {
                                                                    case 'anthropic':
                                                                        keyName = 'Anthropic API Token';
                                                                        placeholder = 'sk-ant-api...';
                                                                        break;
                                                                    case 'openai':
                                                                        keyName = 'OpenAI API Token';
                                                                        placeholder = 'sk-...';
                                                                        break;
                                                                    case 'gemini':
                                                                        keyName = 'Google Gemini API Token';
                                                                        placeholder = 'api_key...';
                                                                        break;
                                                                    default:
                                                                        keyName = 'API Token';
                                                                        placeholder = 'Enter API token';
                                                                }
                                                                
                                                                const inputBox = document.createElement('div');
                                                                inputBox.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
                                                                inputBox.innerHTML = `
                                                                  <div class="bg-gray-800 border border-gray-700 rounded-md p-4 max-w-md w-full">
                                                                    <div class="text-green-400 font-semibold mb-2">Enter ${keyName}</div>
                                                                    <input type="text" id="api-key-input" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded mb-4" placeholder="${placeholder}"/>
                                                                    <div class="flex justify-end space-x-2">
                                                                      <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm" id="cancel-key-btn">Cancel</button>
                                                                      <button class="px-3 py-1 bg-green-700 hover:bg-green-600 text-white rounded text-sm" id="save-key-btn">Save</button>
                                                                    </div>
                                                                  </div>
                                                                `;
                                                                document.body.appendChild(inputBox);
                                                                
                                                                // Focus the input field
                                                                setTimeout(() => {
                                                                  document.getElementById('api-key-input').focus();
                                                                }, 100);
                                                                
                                                                // Add event handlers
                                                                document.getElementById('cancel-key-btn').addEventListener('click', () => {
                                                                  document.body.removeChild(inputBox);
                                                                });
                                                                document.getElementById('save-key-btn').addEventListener('click', () => {
                                                                  const inputEl = document.getElementById('api-key-input');
                                                                  const newKey = inputEl.value.trim();
                                                                  
                                                                  if (newKey) {
                                                                    CookieUtils.setCookie(cookieName, newKey);
                                                                    document.body.removeChild(inputBox);
                                                                    // Force page refresh to update display
                                                                    window.location.reload();
                                                                  } else {
                                                                    // Highlight input with red border if empty
                                                                    inputEl.classList.add('border-red-500');
                                                                    setTimeout(() => {
                                                                      inputEl.classList.remove('border-red-500');
                                                                    }, 2000);
                                                                  }
                                                                });
                                                                
                                                                // Handle enter key
                                                                document.getElementById('api-key-input').addEventListener('keydown', (e) => {
                                                                  if (e.key === 'Enter') {
                                                                    document.getElementById('save-key-btn').click();
                                                                  } else if (e.key === 'Escape') {
                                                                    document.getElementById('cancel-key-btn').click();
                                                                  }
                                                                });
                                                            }
                                                        }}
                                                    >
                                                        {currentKey ? 'Clear' : 'Set'}
                                                    </button>
                                                </div>
                                            );
                                        })()}
                                        
                                        {/* Logout Button */}
                                        <div className="flex items-center space-x-1 bg-gray-900 p-1 rounded">
                                            <button 
                                                className="px-2 py-1 hover:bg-gray-700 rounded text-xs text-red-400"
                                                onClick={handleLogout}
                                            >
                                                Log Out
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            <div className="flex flex-col">
                                <ForgeCodeInput 
                                    authStatus={authStatus}
                                    inputValue={inputValue}
                                    setInputValue={setInputValue}
                                    handleAuthenticate={handleAuthenticate}
                                    handleGenerateCode={handleGenerateCode}
                                    isGenerating={isGenerating}
                                />
                                
                                {/* Language and Options Row - Always show but disable when not authorized */}
                                <div className="mt-1">
                                    <ForgeLanguageSelector 
                                        selectedLanguage={selectedLanguage}
                                        setSelectedLanguage={setSelectedLanguage}
                                        customLanguage={customLanguage}
                                        setCustomLanguage={setCustomLanguage}
                                        commentsLevel={commentsLevel}
                                        setCommentsLevel={setCommentsLevel}
                                        includeErrorHandling={includeErrorHandling}
                                        setIncludeErrorHandling={setIncludeErrorHandling}
                                        disabled={false}
                                        authStatus={authStatus}
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Code Output - Always show */}
                        <div className="mb-4">
                            <ForgeCodeDisplay 
                                generatedCode={generatedCode}
                                selectedLanguage={selectedLanguage}
                                customLanguage={customLanguage}
                                codeOutputRef={codeOutputRef}
                                copyToClipboard={copyToClipboard}
                                downloadCode={downloadCode}
                            />
                        </div>
                    </div>
                </div>
            );
        };
        
        // Render the application
        ReactDOM.render(<GnosisForgeInterface />, document.getElementById('root'));
        {% endraw %}
    </script>
</body>
</html>